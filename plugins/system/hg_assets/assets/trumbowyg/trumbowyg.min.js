$.trumbowyg={langs:{en:{viewHTML:"View HTML",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image",insertVideo:"Insert Video",link:"Link",createLink:"Insert link",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",fullscreen:"fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",invalidUrl:"Invalid URL",description:"Description",title:"Title",text:"Text"}},btnsGrps:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]}},function(t){t.fn.trumbowyg=function(i,s){if(t.isObject(i)||null==i)return this.each(function(){var s=t(this);s.data("trumbowyg")||s.data("trumbowyg",new e(this,i))});if(1==this.length)try{var o=t(this).data("trumbowyg");switch(i){case"openModal":return o.openModal(s.title,s.content);case"closeModal":return o.closeModal();case"openModalInsert":return o.buildInsert(i.title,i.fields,i.callback);case"saveSelection":return o.saveSelection();case"getSelection":return o.selection;case"getSelectedText":return o.selection+"";case"restoreSelection":return o.restoreSelection();case"destroy":return o.destroy();case"lang":return o.lang;case"duration":return o.o.duration}}catch(n){}return!1};var e=function(e,i){this.$e=t(e),this.$creator=t(e),this.lang="undefined"==typeof i||"undefined"==typeof i.lang||"undefined"==typeof t.trumbowyg.langs[i.lang]?t.trumbowyg.langs.en:t.extend(!0,{},t.trumbowyg.langs.en,t.trumbowyg.langs[i.lang]),this.o=t.extend(!0,{lang:"en",dir:"ltr",duration:200,mobile:!1,tablet:!0,closable:!1,fullscreenable:!0,fixedBtnPane:!1,fixedFullWidth:!1,semantic:!1,resetCss:!1,autogrow:!1,prefix:"trumbowyg-",convertLink:!0,btns:["viewHTML","|","formatting","|",t.trumbowyg.btnsGrps.design,"|","link","|","insertImage","|",t.trumbowyg.btnsGrps.justify,"|",t.trumbowyg.btnsGrps.lists,"|","horizontalRule"],btnsAdd:[],btnsDef:{viewHTML:{func:"toggle"},formatting:{dropdown:{defaultFunc:"formatBlock",p:{},blockquote:{},h1:{title:this.lang.header+" 1"},h2:{title:this.lang.header+" 2"},h3:{title:this.lang.header+" 3"},h4:{title:this.lang.header+" 4"}}},p:{func:"formatBlock"},blockquote:{func:"formatBlock"},h1:{func:"formatBlock",title:this.lang.header+" 1"},h2:{func:"formatBlock",title:this.lang.header+" 2"},h3:{func:"formatBlock",title:this.lang.header+" 3"},h4:{func:"formatBlock",title:this.lang.header+" 4"},bold:{},italic:{},underline:{},strikethrough:{},strong:{func:"bold"},em:{func:"italic"},link:{dropdown:{createLink:{},unlink:{}}},insertImage:{},justifyLeft:{},justifyCenter:{},justifyRight:{},justifyFull:{},unorderedList:{func:"insertUnorderedList"},orderedList:{func:"insertOrderedList"},horizontalRule:{func:"insertHorizontalRule"}}},i),this.o.semantic&&!i.btns?this.o.btns=["viewHTML","|","formatting","|",t.trumbowyg.btnsGrps.semantic,"|","link","|","insertImage","|",t.trumbowyg.btnsGrps.justify,"|",t.trumbowyg.btnsGrps.lists,"|","horizontalRule"]:i&&i.btns&&(this.o.btns=i.btns),this.init()};e.prototype={init:function(){return this.height=this.$e.css("height"),this.isEnabled()?(this.buildEditor(!0),void 0):(this.buildEditor(),this.buildBtnPane(),this.fixedBtnPaneEvents(),this.buildOverlay(),void 0)},buildEditor:function(e){if(e!==!0){this.$box=t("<div/>",{"class":this.o.prefix+"box "+this.o.prefix+this.o.lang+" trumbowyg"}),this.isTextarea=!0,this.$e.is("textarea")?this.$editor=t("<div/>"):(this.$editor=this.$e,this.$e=this.buildTextarea().val(this.$e.val()),this.isTextarea=!1),this.$e.hide().addClass(this.o.prefix+"textarea");var i="";this.isTextarea?(i=this.$e.val(),this.$box.insertAfter(this.$e).append(this.$editor).append(this.$e)):(i=this.$editor.html(),this.$box.insertAfter(this.$editor).append(this.$e).append(this.$editor),this.syncCode()),this.$editor.addClass(this.o.prefix+"editor").attr("contenteditable",!0).attr("dir",this.o.dir).html(i),this.o.resetCss&&this.$editor.addClass(this.o.prefix+"reset-css"),this.o.autogrow||(this.$editor.css({height:this.height,overflow:"auto"}),this.$e.css({height:this.height,overflow:"auto"}));var s=this;this.$editor.on("dblclick","img",function(){var e=t(this);return s.buildInsert(s.lang.insertImage,{url:{label:"URL",value:e.attr("src")},alt:{label:s.lang.description,value:e.attr("alt")}},function(t){e.attr("src",t.url),e.attr("alt",t.alt)}),!1}),this.$editor.on("mousedown",function(){s.sementicCode()}),this.$editor.on("blur",function(){s.syncCode()})}else if(!this.$e.is("textarea")){var o=this.buildTextarea().val(this.$e.val());this.$e.hide().after(o)}},buildTextarea:function(){return t('<textarea name="'+this.$e.attr("id")+'"></textarea>',{height:this.height})},buildBtnPane:function(){if(this.o.btns!==!1){var e=this.o.prefix;this.$btnPane=t("<ul/>",{"class":e+"button-pane"}),t.each(this.o.btns.concat(this.o.btnsAdd),t.proxy(function(i,s){try{var o=s.split("btnGrp-");void 0!=o[1]&&(s=t.trumbowyg.btnsGrps[o[1]])}catch(n){}t.isArray(s)||(s=[s]),t.each(s,t.proxy(function(i,s){try{var o=t("<li/>");"|"==s?o.addClass(e+"separator"):("viewHTML"==s&&o.addClass(e+"not-disable"),o.append(this.buildBtn(s))),this.$btnPane.append(o)}catch(n){}},this))},this));var i=t("<li/>",{"class":e+"not-disable "+e+"buttons-right"});this.o.fullscreenable&&i.append(this.buildRightBtn("fullscreen").on("click",t.proxy(function(){var i=e+"fullscreen";this.$box.toggleClass(i),this.$box.hasClass(i)?(t("body").css("overflow","hidden"),this.$box.css({position:"fixed",top:0,left:0,width:"100%",height:"100%",margin:0,padding:0,zIndex:10}),t([this.$editor,this.$e]).each(function(){t(this).css({height:"100%",overflow:"auto"})}),this.$btnPane.css("width","100%")):(t("body").css("overflow","auto"),this.$box.removeAttr("style"),this.o.autogrow||(h=this.height,t([this.$editor,this.$e]).each(function(){t(this).css("height",h)}))),t(window).trigger("scroll")},this))),this.o.closable&&i.append(this.buildRightBtn("close").on("click",t.proxy(function(){var i=e+"fullscreen";this.$box.hasClass(i)&&t("body").css("overflow","auto"),this.destroy()},this))),i.not(":empty")&&this.$btnPane.append(i),this.$box.prepend(this.$btnPane)}},buildBtn:function(e){var i=this.o.btnsDef[e],s=this,o=t("<a/>",{href:"javascript:void(null);","class":this.o.prefix+e+"-button",text:i.text||i.title||this.lang[e]||e,title:i.title||i.text||this.lang[e]||e,mousedown:function(o){return(!i.dropdown||s.$box.find("."+e+"-"+s.o.prefix+"dropdown").is(":hidden"))&&t("body").trigger("mousedown"),s.$btnPane.hasClass(s.o.prefix+"disable")&&!t(this).parent().hasClass(s.o.prefix+"not-disable")?!1:(s.execCommand((i.dropdown?"dropdown":"")||i.func||e,i.param||e),o.stopPropagation(),o.preventDefault(),!1)}});if(i.dropdown){o.addClass(this.o.prefix+"open-dropdown");var n=this.o.prefix+"dropdown"+" "+this.o.prefix+"fixed-top",r=t("<div/>",{"class":e+"-"+n+" "+n});r.data("visible",!1);for(var a in i.dropdown)t.isObject(i.dropdown[a])&&r.append(this.buildSubBtn(i.dropdown,a));this.$box.append(r.hide())}return o},buildSubBtn:function(e,i){t("body").trigger("mousedown");var s=e[i];return t("<a/>",{href:"javascript:void(null);",text:s.text||s.title||this.lang[i]||i,title:s.title||s.text||this.lang[i]||i,mousedown:t.proxy(function(o){return t("body").trigger("mousedown"),this.execCommand(e.defaultFunc||s.func||i,s.param||i),o.stopPropagation(),o.preventDefault(),!1},this)})},buildRightBtn:function(e){return t("<a/>",{href:"javascript:void(null);","class":this.o.prefix+e+"-button",title:this.lang[e],text:this.lang[e]})},buildOverlay:function(){return this.$overlay=t("<div/>",{"class":this.o.prefix+"overlay"}).css({top:this.$btnPane.css("height"),height:this.$editor.outerHeight()}).appendTo(this.$box)},showOverlay:function(){t(window).trigger("scroll"),this.$overlay.fadeIn(this.o.duration),this.$box.addClass(this.o.prefix+"box-blur")},hideOverlay:function(){this.$overlay.fadeOut(this.o.duration/4),this.$box.removeClass(this.o.prefix+"box-blur")},fixedBtnPaneEvents:function(){this.o.fixedBtnPane&&(this.isFixed=!1,t(window).on("scroll",t.proxy(function(){if(this.$box){this.syncCode();var e=t(window).scrollTop(),i=this.$box.offset().top+2,s=e-i>0&&e-i-parseInt(this.height.replace("px",""))<0;s?(this.isFixed||(this.isFixed=!0,this.$btnPane.css({position:"fixed",top:0,left:this.o.fixedFullWidth?"0":"auto",width:this.o.fixedFullWidth?"100%":this.$box.css("width"),zIndex:7}),this.$editor.css({marginTop:this.$btnPane.css("height")}),this.$e.css({marginTop:this.$btnPane.css("height")})),t("."+this.o.prefix+"fixed-top",this.$box).css({position:this.o.fixedFullWidth?"fixed":"absolute",top:this.o.fixedFullWidth?this.$btnPane.css("height"):parseInt(this.$btnPane.css("height").replace("px",""))+(e-i)+"px",zIndex:15})):this.isFixed&&(this.isFixed=!1,this.$btnPane.css({position:"relative"}),this.$editor.css({marginTop:0}),this.$e.css({marginTop:0}),t("."+this.o.prefix+"fixed-top",this.$box).css({position:"absolute",top:this.$btnPane.css("height")}))}},this)))},destroy:function(){var t=this.getCode();this.isTextarea?this.$box.after(this.$e.css({height:this.height}).val(t).removeClass(this.o.prefix+"textarea").show()):this.$box.after(this.$editor.css({height:this.height}).removeClass(this.o.prefix+"editor").attr("contenteditable",!1).html(t).show()),this.$box.remove(),this.$creator.removeData("trumbowyg")},toggle:function(){this.sementicCode(),this.$editor.toggle(),this.$e.toggle(),this.$btnPane.toggleClass(this.o.prefix+"disable"),this.$btnPane.find("."+this.o.prefix+"viewHTML-button").toggleClass(this.o.prefix+"active")},dropdown:function(e){var i=this.$box.find("."+e+"-"+this.o.prefix+"dropdown"),s=this.$btnPane.find("."+this.o.prefix+e+"-button");i.is(":hidden")?(s.addClass(this.o.prefix+"active"),i.css({position:"absolute",top:this.$btnPane.css("height"),left:this.o.fixedFullWidth&&this.isFixed?s.offset().left+"px":s.offset().left-this.$btnPane.offset().left+"px"}).show(),t(window).trigger("scroll"),t("body").on("mousedown",t.proxy(function(){t("."+this.o.prefix+"dropdown").hide(),t("."+this.o.prefix+"active").removeClass(this.o.prefix+"active"),t("body").off("mousedown")},this))):t("body").trigger("mousedown")},getCode:function(){return this.$e.val()},setCode:function(t){this.$e.val(t)},syncCode:function(){this.$editor.is(":visible")?this.$e.val(this.$editor.html()):this.$editor.html(this.$e.val()),this.o.autogrow&&(this.height=this.$editor.css("height"),this.$e.css({height:this.height}))},sementicCode:function(){this.syncCode(),this.o.semantic&&(this.sementicTag("b","strong"),this.sementicTag("i","em"),this.$e.val(this.$editor.html()))},sementicTag:function(e,i){t(e,this.$editor).each(function(){t(this).replaceWith(function(){return"<"+i+">"+t(this).html()+"</"+i+">"})})},createLink:function(){this.saveSelection(),this.buildInsert(this.lang.createLink,{url:{label:"URL",value:"http://",required:!0},title:{label:this.lang.title,value:this.selection},text:{label:this.lang.text,value:this.selection}},"createLink")},insertImage:function(){this.saveSelection(),this.buildInsert(this.lang.insertImage,{url:{label:"URL",value:"http://"},alt:{label:this.lang.description,value:this.selection}},"insertImage")},execCommand:function(t,e){"dropdown"!=t&&this.$editor.focus();try{this[t](e)}catch(i){try{t(e)}catch(i){this.$editor.focus(),"insertHorizontalRule"==t&&(e=null),document.execCommand(t,!1,e)}}this.syncCode()},formatBlock:function(e){t.browser.msie&&(e="<"+e+">"),document.execCommand("formatBlock",!1,e),this.syncCode()},openModal:function(e,i){var s=this.o.prefix;if(t("."+s+"modal-box",this.$box).size()>0)return!1;this.saveSelection(),this.showOverlay(),this.$btnPane.addClass(s+"disable"),t("."+s+"not-disable",this.$btnPane).not("."+s+"buttons-right").removeClass(s+"not-disable").addClass(s+"not-disable-old");var o=t("<div/>",{"class":s+"modal "+s+"fixed-top"}).css({top:this.$btnPane.css("height")}).appendTo(this.$box);this.$overlay.one("click",function(t){o.trigger(s+"cancel"),t.preventDefault()}),$e=this.$editor,$form=t("<form/>",{action:"javascript:void(null);",html:i}).on("submit",function(t){o.trigger(s+"confirm"),t.preventDefault()}).on("reset",function(t){o.trigger(s+"cancel"),t.preventDefault()});var n=t("<div/>",{"class":s+"modal-box",html:$form}).css("top","-"+o.css("height")).appendTo(o).animate({top:0},this.o.duration);return t("<span/>",{text:e,"class":s+"modal-title"}).prependTo(n),n.find("input:first").focus(),this.buildModalBtn("submit",n),this.buildModalBtn("reset",n),t("body").trigger("scroll"),o},buildModalBtn:function(e,i){return t("<input/>",{"class":this.o.prefix+"modal-button "+this.o.prefix+"modal-"+e,value:this.lang[e]||e,type:e}).appendTo(i.find("form"))},closeModal:function(){this.$btnPane.removeClass(this.o.prefix+"disable"),this.$overlay.off(),t("."+this.o.prefix+"not-disable-old",this.$btnPane).removeClass(this.o.prefix+"not-disable-old").addClass(this.o.prefix+"not-disable"),that=this,$modalBox=t("."+this.o.prefix+"modal-box",this.$box),$modalBox.animate({top:"-"+$modalBox.css("height")},this.o.duration/2,function(){t(this).parent().remove(),that.hideOverlay()})},buildInsert:function(e,i,s){var o="";for(f in i)void 0==i[f].label&&(i[f].label=f.charAt(0).toUpperCase()+f.slice(1)),void 0==i[f].name&&(i[f].name=f),f=i[f],o+='<label><input type="text" name="'+f.name+'" value="'+(f.value||"")+'" '+(f.required?"required":"")+'><span class="'+this.o.prefix+'input-infos"><span>'+f.label+"</span></span></label>";var n=this.openModal(e,o),r=this;n.on(this.o.prefix+"confirm",function(){var e=t(this).find("form"),o={};for(f in i)o[f]=t('input[name="'+f+'"]',e).val();if(null!=o.url&&void 0!=o.url){var a=/^(http|https):\/\/([\w~#!:.?+=&%@!\-\/]+)$/;a.test(o.url)?(r.restoreSelection(),t.isString(s)?document.execCommand(s,!1,o.url):s(o),r.syncCode(),r.closeModal(),n.off(r.o.prefix+"confirm")):r.addErrorOnModalField(e.find("input[name=url]"),r.lang.invalidUrl)}}),n.one(this.o.prefix+"cancel",function(){n.off(r.o.prefix+"confirm"),r.closeModal(),r.restoreSelection()})},addErrorOnModalField:function(t,e){var i=t.parent(),s=this.o.prefix;i.addClass(s+"input-error"),t.on("change keyup",function(){i.removeClass(s+"input-error")}),i.find("input+span").append('<span class="'+s+'msg-error">'+e+"</span>")},saveSelection:function(){if(this.selection=null,window.getSelection){var t=window.getSelection();t.getRangeAt&&t.rangeCount&&(this.selection=t.getRangeAt(0))}else document.selection&&document.selection.createRange&&(this.selection=document.selection.createRange())},restoreSelection:function(){if(range=this.selection)if(window.getSelection){var t=window.getSelection();t.removeAllRanges(),t.addRange(range)}else document.selection&&range.select&&range.select()},isEnabled:function(){var t="iPhone|iPod|Android|BlackBerry|WindowssPhone|ZuneWP7",e=new RegExp("(iPad|webOS)"),i=new RegExp("("+t+")");return this.o.tablet===!0&&e.test(navigator.userAgent)||this.o.mobile===!0&&i.test(navigator.userAgent)}};var i=Object.prototype.toString,s=Object.prototype.hasOwnProperty;t.isObject=function(t){if("[object Object]"!==i.call(t))return!1;var e;for(e in t);return!e||s.call(t,e)},t.isString=function(t){return"string"==typeof t}}(jQuery);